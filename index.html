<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe</title>
    <style>
        :root {
            /* Light Theme (Default) */
            --bg-color: #f5f5f5;
            --text-color: #333;
            --header-color: #444;
            --board-bg: #fff;
            --cell-border: #ddd;
            --btn-bg: #e0e0e0;
            --btn-hover: #d0d0d0;
            --btn-text: #333;
            --x-color: #3498db;
            --o-color: #e74c3c;
            --winner-bg: rgba(46, 204, 113, 0.3);
            --settings-bg: rgba(255, 255, 255, 0.95);
            --settings-border: #ddd;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-color: #222;
            --text-color: #eee;
            --header-color: #fff;
            --board-bg: #333;
            --cell-border: #444;
            --btn-bg: #444;
            --btn-hover: #555;
            --btn-text: #fff;
            --x-color: #3498db;
            --o-color: #e74c3c;
            --winner-bg: rgba(46, 204, 113, 0.3);
            --settings-bg: rgba(34, 34, 34, 0.95);
            --settings-border: #444;
        }

        /* Minimalist Theme */
        [data-theme="minimalist"] {
            --bg-color: #fff;
            --text-color: #333;
            --header-color: #333;
            --board-bg: #fff;
            --cell-border: #eee;
            --btn-bg: #f9f9f9;
            --btn-hover: #f0f0f0;
            --btn-text: #333;
            --x-color: #555;
            --o-color: #777;
            --winner-bg: rgba(200, 200, 200, 0.3);
            --settings-bg: rgba(255, 255, 255, 0.95);
            --settings-border: #eee;
        }

        /* Ocean Theme */
        [data-theme="ocean"] {
            --bg-color: #e0f7fa;
            --text-color: #006064;
            --header-color: #00838f;
            --board-bg: #b2ebf2;
            --cell-border: #80deea;
            --btn-bg: #4dd0e1;
            --btn-hover: #26c6da;
            --btn-text: #006064;
            --x-color: #0277bd;
            --o-color: #00838f;
            --winner-bg: rgba(0, 172, 193, 0.3);
            --settings-bg: rgba(224, 247, 250, 0.95);
            --settings-border: #80deea;
        }

        /* Forest Theme */
        [data-theme="forest"] {
            --bg-color: #e8f5e9;
            --text-color: #1b5e20;
            --header-color: #2e7d32;
            --board-bg: #c8e6c9;
            --cell-border: #a5d6a7;
            --btn-bg: #81c784;
            --btn-hover: #66bb6a;
            --btn-text: #1b5e20;
            --x-color: #2e7d32;
            --o-color: #558b2f;
            --winner-bg: rgba(76, 175, 80, 0.3);
            --settings-bg: rgba(232, 245, 233, 0.95);
            --settings-border: #a5d6a7;
        }

        /* Sunset Theme */
        [data-theme="sunset"] {
            --bg-color: #fff8e1;
            --text-color: #ff6f00;
            --header-color: #f57c00;
            --board-bg: #ffecb3;
            --cell-border: #ffd54f;
            --btn-bg: #ffca28;
            --btn-hover: #ffc107;
            --btn-text: #ff6f00;
            --x-color: #e65100;
            --o-color: #ff8f00;
            --winner-bg: rgba(255, 167, 38, 0.3);
            --settings-bg: rgba(255, 248, 225, 0.95);
            --settings-border: #ffd54f;
        }

        /* Monochrome Theme */
        [data-theme="monochrome"] {
            --bg-color: #f5f5f5;
            --text-color: #212121;
            --header-color: #000;
            --board-bg: #e0e0e0;
            --cell-border: #bdbdbd;
            --btn-bg: #9e9e9e;
            --btn-hover: #757575;
            --btn-text: #212121;
            --x-color: #000;
            --o-color: #424242;
            --winner-bg: rgba(158, 158, 158, 0.3);
            --settings-bg: rgba(245, 245, 245, 0.95);
            --settings-border: #bdbdbd;
        }

        /* Retro Theme */
        [data-theme="retro"] {
            --bg-color: #ffe0b2;
            --text-color: #5d4037;
            --header-color: #4e342e;
            --board-bg: #d7ccc8;
            --cell-border: #a1887f;
            --btn-bg: #bcaaa4;
            --btn-hover: #a1887f;
            --btn-text: #3e2723;
            --x-color: #6d4c41;
            --o-color: #5d4037;
            --winner-bg: rgba(161, 136, 127, 0.3);
            --settings-bg: rgba(255, 224, 178, 0.95);
            --settings-border: #a1887f;
        }

        /* Neon Theme */
        [data-theme="neon"] {
            --bg-color: #111;
            --text-color: #fff;
            --header-color: #0ff;
            --board-bg: #222;
            --cell-border: #333;
            --btn-bg: #0ff;
            --btn-hover: #0cc;
            --btn-text: #000;
            --x-color: #f0f;
            --o-color: #0f0;
            --winner-bg: rgba(0, 255, 255, 0.3);
            --settings-bg: rgba(17, 17, 17, 0.95);
            --settings-border: #0ff;
        }

        /* Pastel Theme */
        [data-theme="pastel"] {
            --bg-color: #f8bbd0;
            --text-color: #ad1457;
            --header-color: #c2185b;
            --board-bg: #f48fb1;
            --cell-border: #f06292;
            --btn-bg: #ec407a;
            --btn-hover: #e91e63;
            --btn-text: #fff;
            --x-color: #ad1457;
            --o-color: #880e4f;
            --winner-bg: rgba(236, 64, 122, 0.3);
            --settings-bg: rgba(248, 187, 208, 0.95);
            --settings-border: #f06292;
        }

        /* Autumn Theme */
        [data-theme="autumn"] {
            --bg-color: #fff3e0;
            --text-color: #bf360c;
            --header-color: #e65100;
            --board-bg: #ffe0b2;
            --cell-border: #ffcc80;
            --btn-bg: #ffb74d;
            --btn-hover: #ffa726;
            --btn-text: #bf360c;
            --x-color: #e65100;
            --o-color: #bf360c;
            --winner-bg: rgba(255, 183, 77, 0.3);
            --settings-bg: rgba(255, 243, 224, 0.95);
            --settings-border: #ffcc80;
        }

        /* Space Theme */
        [data-theme="space"] {
            --bg-color: #1a237e;
            --text-color: #e8eaf6;
            --header-color: #7986cb;
            --board-bg: #303f9f;
            --cell-border: #3949ab;
            --btn-bg: #5c6bc0;
            --btn-hover: #3f51b5;
            --btn-text: #e8eaf6;
            --x-color: #8c9eff;
            --o-color: #536dfe;
            --winner-bg: rgba(92, 107, 192, 0.3);
            --settings-bg: rgba(26, 35, 126, 0.95);
            --settings-border: #3949ab;
        }

        /* Colorful Theme */
        [data-theme="colorful"] {
            --bg-color: #ffeb3b;
            --text-color: #d50000;
            --header-color: #6200ea;
            --board-bg: #76ff03;
            --cell-border: #00b0ff;
            --btn-bg: #ff4081;
            --btn-hover: #f50057;
            --btn-text: #fff;
            --x-color: #6200ea;
            --o-color: #2962ff;
            --winner-bg: rgba(255, 64, 129, 0.3);
            --settings-bg: rgba(255, 235, 59, 0.95);
            --settings-border: #00b0ff;
        }

        /* Cyberpunk Theme */
        [data-theme="cyberpunk"] {
            --bg-color: #0c0c14;
            --text-color: #ff00ff;
            --header-color: #00ffff;
            --board-bg: #1a1a2e;
            --cell-border: #282846;
            --btn-bg: #7b00ff;
            --btn-hover: #6200cc;
            --btn-text: #00ffff;
            --x-color: #ff00ff;
            --o-color: #00ffff;
            --winner-bg: rgba(123, 0, 255, 0.3);
            --settings-bg: rgba(12, 12, 20, 0.95);
            --settings-border: #7b00ff;
        }

        /* Coffee Theme */
        [data-theme="coffee"] {
            --bg-color: #efebe9;
            --text-color: #3e2723;
            --header-color: #4e342e;
            --board-bg: #d7ccc8;
            --cell-border: #bcaaa4;
            --btn-bg: #a1887f;
            --btn-hover: #8d6e63;
            --btn-text: #fff;
            --x-color: #5d4037;
            --o-color: #4e342e;
            --winner-bg: rgba(161, 136, 127, 0.3);
            --settings-bg: rgba(239, 235, 233, 0.95);
            --settings-border: #bcaaa4;
        }

        /* Candy Theme */
        [data-theme="candy"] {
            --bg-color: #f8bbd0;
            --text-color: #6a1b9a;
            --header-color: #9c27b0;
            --board-bg: #f3e5f5;
            --cell-border: #e1bee7;
            --btn-bg: #ba68c8;
            --btn-hover: #ab47bc;
            --btn-text: #fff;
            --x-color: #9c27b0;
            --o-color: #6a1b9a;
            --winner-bg: rgba(186, 104, 200, 0.3);
            --settings-bg: rgba(248, 187, 208, 0.95);
            --settings-border: #e1bee7;
        }

        /* Beach Theme */
        [data-theme="beach"] {
            --bg-color: #e0f7fa;
            --text-color: #00796b;
            --header-color: #0097a7;
            --board-bg: #b2ebf2;
            --cell-border: #80deea;
            --btn-bg: #26c6da;
            --btn-hover: #00bcd4;
            --btn-text: #006064;
            --x-color: #00796b;
            --o-color: #00695c;
            --winner-bg: rgba(38, 198, 218, 0.3);
            --settings-bg: rgba(224, 247, 250, 0.95);
            --settings-border: #80deea;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin: 0;
            color: var(--header-color);
        }

        h2 {
            font-size: 1.8rem;
            margin: 10px 0;
            color: var(--header-color);
            opacity: 0.8;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
        }

        .score-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .score-box {
            text-align: center;
            padding: 10px 20px;
            background-color: var(--board-bg);
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .status-message {
            margin: 15px 0;
            font-size: 1.2rem;
            font-weight: bold;
            height: 1.5em;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            margin-bottom: 20px;
            background-color: var(--board-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .cell {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            background-color: var(--board-bg);
            border: 2px solid var(--cell-border);
            border-radius: 5px;
            transition: all 0.2s;
        }

        .cell:hover {
            background-color: var(--btn-hover);
            transform: scale(1.05);
        }

        .cell.x {
            color: var(--x-color);
        }

        .cell.o {
            color: var(--o-color);
        }

        .cell.winner {
            background-color: var(--winner-bg);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 15px;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            background-color: var(--btn-bg);
            color: var(--btn-text);
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background-color: var(--btn-hover);
            transform: scale(1.05);
        }

        .settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
            background-color: var(--settings-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 20px;
            border: 1px solid var(--settings-border);
            z-index: 1000;
            display: none;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            padding: 5px;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group h3 {
            margin-bottom: 10px;
            border-bottom: 1px solid var(--cell-border);
            padding-bottom: 5px;
        }

        .theme-options, .difficulty-options, .symbol-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .theme-btn, .difficulty-btn, .symbol-btn {
            padding: 8px 12px;
            font-size: 0.9rem;
            border-radius: 20px;
        }

        .active {
            border: 2px solid var(--text-color);
            font-weight: bold;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .history-container {
            display: none;
            margin-top: 20px;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--board-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .history-move {
            padding: 5px;
            margin: 5px 0;
            border-bottom: 1px solid var(--cell-border);
        }

        @media (max-width: 500px) {
            .cell {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body data-theme="light">
    <header>
        <h1>Tic Tac Toe</h1>
    </header>

    <div class="game-container">
        <div class="score-container">
            <div class="score-box">
                <div>Player:</div>
                <div id="player-score">0</div>
            </div>
            <div class="score-box">
                <div>AI:</div>
                <div id="ai-score">0</div>
            </div>
        </div>

        <div class="status-message" id="status">Your turn!</div>

        <div class="board" id="board">
            <div class="cell" data-index="0"></div>
            <div class="cell" data-index="1"></div>
            <div class="cell" data-index="2"></div>
            <div class="cell" data-index="3"></div>
            <div class="cell" data-index="4"></div>
            <div class="cell" data-index="5"></div>
            <div class="cell" data-index="6"></div>
            <div class="cell" data-index="7"></div>
            <div class="cell" data-index="8"></div>
        </div>

        <div class="controls">
            <button id="settings-btn">Game Settings</button>
            <button id="undo-btn">Undo Move</button>
            <button id="reset-round-btn">Reset Round</button>
            <button id="reset-scores-btn">Reset Scores</button>
            <button id="history-btn">Show History</button>
        </div>

        <div class="history-container" id="history-container">
            <h3>Game History</h3>
            <div id="history-list"></div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <h3>Game Settings</h3>
            <button class="close-settings" id="close-settings">×</button>
        </div>

        <div class="settings-group">
            <h3>Game Theme</h3>
            <div class="theme-options">
                <button class="theme-btn active" data-theme="light">Light</button>
                <button class="theme-btn" data-theme="dark">Dark</button>
                <button class="theme-btn" data-theme="minimalist">Minimalist</button>
                <button class="theme-btn" data-theme="ocean">Ocean</button>
                <button class="theme-btn" data-theme="forest">Forest</button>
                <button class="theme-btn" data-theme="sunset">Sunset</button>
                <button class="theme-btn" data-theme="monochrome">Monochrome</button>
                <button class="theme-btn" data-theme="retro">Retro</button>
                <button class="theme-btn" data-theme="neon">Neon</button>
                <button class="theme-btn" data-theme="pastel">Pastel</button>
                <button class="theme-btn" data-theme="autumn">Autumn</button>
                <button class="theme-btn" data-theme="space">Space</button>
                <button class="theme-btn" data-theme="colorful">Colorful</button>
                <button class="theme-btn" data-theme="cyberpunk">Cyberpunk</button>
                <button class="theme-btn" data-theme="coffee">Coffee</button>
                <button class="theme-btn" data-theme="candy">Candy</button>
                <button class="theme-btn" data-theme="beach">Beach</button>
            </div>
        </div>

        <div class="settings-group">
            <h3>AI Difficulty</h3>
            <div class="difficulty-options">
                <button class="difficulty-btn active" data-difficulty="easy">Easy</button>
                <button class="difficulty-btn" data-difficulty="medium">Medium</button>
                <button class="difficulty-btn" data-difficulty="hard">Hard</button>
            </div>
        </div>

        <div class="settings-group">
            <h3>Player Symbol</h3>
            <div class="symbol-options">
                <button class="symbol-btn active" data-symbol="X">Play as X</button>
                <button class="symbol-btn" data-symbol="O">Play as O</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Game state
            let board = ['', '', '', '', '', '', '', '', ''];
            let currentPlayer = 'X';
            let gameActive = true;
            let playerSymbol = 'X';
            let aiSymbol = 'O';
            let playerScore = 0;
            let aiScore = 0;
            let moveHistory = [];
            let gameHistory = [];
            let aiDifficulty = 'easy';
            
            // DOM elements
            const boardElement = document.getElementById('board');
            const cells = document.querySelectorAll('.cell');
            const statusDisplay = document.getElementById('status');
            const playerScoreDisplay = document.getElementById('player-score');
            const aiScoreDisplay = document.getElementById('ai-score');
            const historyContainer = document.getElementById('history-container');
            const historyList = document.getElementById('history-list');
            const settingsPanel = document.getElementById('settings-panel');
            const overlay = document.getElementById('overlay');
            
            // Winning combinations
            const winningConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6]             // Diagonals
            ];
            
            // Initialize game
            initGame();
            
            function initGame() {
                cells.forEach(cell => {
                    cell.addEventListener('click', () => handleCellClick(cell));
                    cell.textContent = '';
                    cell.classList.remove('x', 'o', 'winner');
                });
                
                document.getElementById('undo-btn').addEventListener('click', undoMove);
                document.getElementById('reset-round-btn').addEventListener('click', resetRound);
                document.getElementById('reset-scores-btn').addEventListener('click', resetScores);
                document.getElementById('history-btn').addEventListener('click', toggleHistory);
                document.getElementById('settings-btn').addEventListener('click', toggleSettings);
                document.getElementById('close-settings').addEventListener('click', toggleSettings);
                overlay.addEventListener('click', toggleSettings);
                
                // Theme buttons
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        document.body.setAttribute('data-theme', btn.getAttribute('data-theme'));
                    });
                });
                
                // Difficulty buttons
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        aiDifficulty = btn.getAttribute('data-difficulty');
                    });
                });
                
                // Symbol buttons
                document.querySelectorAll('.symbol-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.symbol-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const newSymbol = btn.getAttribute('data-symbol');
                        if (newSymbol !== playerSymbol) {
                            playerSymbol = newSymbol;
                            aiSymbol = playerSymbol === 'X' ? 'O' : 'X';
                            resetRound();
                            
                            // If AI goes first (player is O)
                            if (playerSymbol === 'O') {
                                setTimeout(makeAiMove, 500);
                            }
                        }
                    });
                });
                
                updateStatusMessage();
            }
            
            function handleCellClick(cell) {
                const index = cell.getAttribute('data-index');
                
                if (board[index] !== '' || !gameActive || currentPlayer !== playerSymbol) {
                    return;
                }
                
                makeMove(index, playerSymbol);
                
                if (gameActive) {
                    setTimeout(makeAiMove, 500);
                }
            }
            
            function makeMove(index, symbol) {
                board[index] = symbol;
                moveHistory.push({
                    index: index,
                    symbol: symbol
                });
                
                const cell = cells[index];
                cell.textContent = symbol;
                cell.classList.add(symbol.toLowerCase());
                
                updateHistory(`${symbol} played at position ${parseInt(index) + 1}`);
                
                if (checkWin(symbol)) {
                    endGame(false);
                } else if (checkDraw()) {
                    endGame(true);
                } else {
                    currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                    updateStatusMessage();
                }
            }
            
            function makeAiMove() {
                if (!gameActive || currentPlayer !== aiSymbol) {
                    return;
                }
                
                let moveIndex;
                
                switch (aiDifficulty) {
                    case 'hard':
                        moveIndex = getBestMove();
                        break;
                    case 'medium':
                        if (Math.random() < 0.7) {
                            moveIndex = getSmartMove();
                        } else {
                            moveIndex = getRandomMove();
                        }
                        break;
                    case 'easy':
                    default:
                        if (Math.random() < 0.3) {
                            moveIndex = getSmartMove();
                        } else {
                            moveIndex = getRandomMove();
                        }
                        break;
                }
                
                makeMove(moveIndex, aiSymbol);
            }
            
            function getRandomMove() {
                const availableMoves = board.map((cell, index) => cell === '' ? index : null).filter(index => index !== null);
                return availableMoves[Math.floor(Math.random() * availableMoves.length)];
            }
            
            function getSmartMove() {
                // First try to win
                for (let i = 0; i < winningConditions.length; i++) {
                    const [a, b, c] = winningConditions[i];
                    if (board[a] === aiSymbol && board[b] === aiSymbol && board[c] === '') {
                        return c;
                    }
                    if (board[a] === aiSymbol && board[c] === aiSymbol && board[b] === '') {
                        return b;
                    }
                    if (board[b] === aiSymbol && board[c] === aiSymbol && board[a] === '') {
                        return a;
                    }
                }
                
                // Then try to block
                for (let i = 0; i < winningConditions.length; i++) {
                    const [a, b, c] = winningConditions[i];
                    if (board[a] === playerSymbol && board[b] === playerSymbol && board[c] === '') {
                        return c;
                    }
                    if (board[a] === playerSymbol && board[c] === playerSymbol && board[b] === '') {
                        return b;
                    }
                    if (board[b] === playerSymbol && board[c] === playerSymbol && board[a] === '') {
                        return a;
                    }
                }
                
                // Take center if available
                if (board[4] === '') {
                    return 4;
                }
                
                // Take a random corner
                const corners = [0, 2, 6, 8].filter(index => board[index] === '');
                if (corners.length > 0) {
                    return corners[Math.floor(Math.random() * corners.length)];
                }
                
                // Take any available move
                return getRandomMove();
            }
            
            function getBestMove() {
                // Minimax implementation for unbeatable AI
                function minimax(newBoard, depth, isMaximizing) {
                    // Check for terminal states
                    const winner = checkWinningCondition(newBoard);
                    if (winner === aiSymbol) return 10 - depth;
                    if (winner === playerSymbol) return depth - 10;
                    if (checkBoardFull(newBoard)) return 0;
                    
                    if (isMaximizing) {
                        let bestScore = -Infinity;
                        for (let i = 0; i < 9; i++) {
                            if (newBoard[i] === '') {
                                newBoard[i] = aiSymbol;
                                const score = minimax(newBoard, depth + 1, false);
                                newBoard[i] = '';
                                bestScore = Math.max(score, bestScore);
                            }
                        }
                        return bestScore;
                    } else {
                        let bestScore = Infinity;
                        for (let i = 0; i < 9; i++) {
                            if (newBoard[i] === '') {
                                newBoard[i] = playerSymbol;
                                const score = minimax(newBoard, depth + 1, true);
                                newBoard[i] = '';
                                bestScore = Math.min(score, bestScore);
                            }
                        }
                        return bestScore;
                    }
                }
                
                function checkWinningCondition(board) {
                    for (let i = 0; i < winningConditions.length; i++) {
                        const [a, b, c] = winningConditions[i];
                        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                            return board[a];
                        }
                    }
                    return null;
                }
                
                function checkBoardFull(board) {
                    return board.every(cell => cell !== '');
                }
                
                // Actual minimax move calculation
                let bestScore = -Infinity;
                let bestMove;
                
                // Add randomness to make the AI beatable occasionally on hard difficulty
                if (Math.random() < 0.2) {
                    return getRandomMove();
                }
                
                for (let i = 0; i < 9; i++) {
                    if (board[i] === '') {
                        board[i] = aiSymbol;
                        const score = minimax(board, 0, false);
                        board[i] = '';
                        if (score > bestScore) {
                            bestScore = score;
                            bestMove = i;
                        }
                    }
                }
                
                return bestMove;
            }
            
            function checkWin(symbol) {
                for (let i = 0; i < winningConditions.length; i++) {
                    const [a, b, c] = winningConditions[i];
                    
                    if (board[a] === symbol && board[b] === symbol && board[c] === symbol) {
                        cells[a].classList.add('winner');
                        cells[b].classList.add('winner');
                        cells[c].classList.add('winner');
                        return true;
                    }
                }
                
                return false;
            }
            
            function checkDraw() {
                return board.every(cell => cell !== '');
            }
            
            function endGame(isDraw) {
                gameActive = false;
                
                if (isDraw) {
                    statusDisplay.textContent = "It's a draw!";
                    gameHistory.push({
                        result: 'draw',
                        moves: [...moveHistory]
                    });
                } else {
                    if (currentPlayer === playerSymbol) {
                        statusDisplay.textContent = "You won!";
                        playerScore++;
                        playerScoreDisplay.textContent = playerScore;
                        gameHistory.push({
                            result: 'player win',
                            moves: [...moveHistory]
                        });
                    } else {
                        statusDisplay.textContent = "AI won!";
                        aiScore++;
                        aiScoreDisplay.textContent = aiScore;
                        gameHistory.push({
                            result: 'ai win',
                            moves: [...moveHistory]
                        });
                    }
                }
            }
            
            function undoMove() {
                if (moveHistory.length < 2 || !gameActive) {
                    return;
                }
                
                // Undo both AI and player moves
                const aiMove = moveHistory.pop();
                const playerMove = moveHistory.pop();
                
                // Reset the cells
                cells[aiMove.index].textContent = '';
                cells[aiMove.index].classList.remove('x', 'o');
                board[aiMove.index] = '';
                
                cells[playerMove.index].textContent = '';
                cells[playerMove.index].classList.remove('x', 'o');
                board[playerMove.index] = '';
                
                // Update history display
                updateHistory('Moves undone');
                
                currentPlayer = playerSymbol;
                updateStatusMessage();
            }
            
            function resetRound() {
                board = ['', '', '', '', '', '', '', '', ''];
                gameActive = true;
                moveHistory = [];
                
                cells.forEach(cell => {
                    cell.textContent = '';
                    cell.classList.remove('x', 'o', 'winner');
                });
                
                currentPlayer = 'X';
                updateStatusMessage();
                
                // If player is O, AI goes first
                if (playerSymbol === 'O') {
                    setTimeout(makeAiMove, 500);
                }
                
                updateHistory('Round reset');
            }
            
            function resetScores() {
                playerScore = 0;
                aiScore = 0;
                playerScoreDisplay.textContent = '0';
                aiScoreDisplay.textContent = '0';
                gameHistory = [];
                updateHistory('Scores reset');
            }
            
            function updateStatusMessage() {
                if (gameActive) {
                    if (currentPlayer === playerSymbol) {
                        statusDisplay.textContent = "Your turn!";
                    } else {
                        statusDisplay.textContent = "AI is thinking...";
                    }
                }
            }
            
            function updateHistory(message) {
                const historyItem = document.createElement('div');
                historyItem.classList.add('history-move');
                historyItem.textContent = message;
                historyList.prepend(historyItem);
                
                // Limit history items
                if (historyList.children.length > 10) {
                    historyList.removeChild(historyList.lastChild);
                }
            }
            
            function toggleHistory() {
                historyContainer.style.display = historyContainer.style.display === 'block' ? 'none' : 'block';
                document.getElementById('history-btn').textContent = historyContainer.style.display === 'block' ? 'Hide History' : 'Show History';
            }
            
            function toggleSettings() {
                const isVisible = settingsPanel.style.display === 'block';
                settingsPanel.style.display = isVisible ? 'none' : 'block';
                overlay.style.display = isVisible ? 'none' : 'block';
            }
        });
    </script>
</body>
</html>
